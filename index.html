<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>퀴즈감귤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        // Firestore and Auth instances
        let app;
        let db;
        let auth;
        let userId;
        // 관리자 상태를 브라우저에 저장
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        // 경고: 이 데모에서는 비밀번호를 JavaScript 변수로 관리합니다. 실제 애플리케이션에서는
        // 사용자 인증 시스템(예: Firebase Authentication)을 사용해야 합니다.
        let adminPassword = 'gamgyul';

        // ======================================================================================
        // 여기에 여러분의 Firebase 설정값을 붙여넣어 주세요.
        // ======================================================================================
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCKUUty_87HsQIlpsSNZunnHpULAlM32Pc",
  authDomain: "quiz-gamgule.firebaseapp.com",
  projectId: "quiz-gamgule",
  storageBucket: "quiz-gamgule.firebasestorage.app",
  messagingSenderId: "338874271866",
  appId: "1:338874271866:web:0daa61b1ffac399afcd3c3",
  measurementId: "G-M7XC207KW3"
};

        const appId = "default-app-id";
        const initialAuthToken = null;

        let isAuthReady = false;
        
        // Firestore collection path
        const QUIZ_COLLECTION_PATH = `artifacts/${appId}/public/data/quiz_answers`;
        
        // Get UI elements
        const quizForm = document.getElementById('quiz-form');
        const resultsContainer = document.getElementById('results-container');
        const participantView = document.getElementById('participant-view');
        const adminView = document.getElementById('admin-view');
        const adminLoginView = document.getElementById('admin-login-view');
        const revealButton = document.getElementById('reveal-button');
        const resetButton = document.getElementById('reset-button');
        const statusMessage = document.getElementById('status-message');
        const resultsListAdmin = document.getElementById('quiz-results-list-admin');
        const resultsListFinal = document.getElementById('quiz-results-list-final');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLoginPass = document.getElementById('admin-login-password');
        const backToParticipantButton = document.getElementById('back-to-participant');
        const backToAdminButton = document.getElementById('back-to-admin');
        const adminButton = document.getElementById('admin-button');
        const changePasswordButton = document.getElementById('change-password-button');
        const passwordModal = document.getElementById('password-modal');
        const changePassForm = document.getElementById('change-password-form');
        const cancelChangePassButton = document.getElementById('cancel-change-password');
        const currentPassInput = document.getElementById('current-password');
        const newPassInput = document.getElementById('new-password');
        const confirmNewPassInput = document.getElementById('confirm-new-password');

        // Initialize and authenticate Firebase
        const initFirebase = async () => {
            if (!firebaseConfig.apiKey) {
                showTemporaryMessage("Firebase 설정이 필요합니다. 코드를 수정해주세요.", 'bg-red-500');
                console.error("Firebase config is not available. Please fill in your Firebase project details.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                    isAuthReady = true;
                    console.log('Firebase is ready.');
                    setupRealtimeListener();
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showTemporaryMessage("Firebase 연결에 실패했습니다. 설정을 확인해주세요.", 'bg-red-500');
            }
        };

        const setupRealtimeListener = () => {
            if (!isAuthReady) return;

            const q = query(collection(db, QUIZ_COLLECTION_PATH));

            onSnapshot(q, (snapshot) => {
                let answers = [];
                let revealed = false;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    answers.push({ id: doc.id, ...data });
                    if (data.revealed) {
                        revealed = true;
                    }
                });
                
                // onSnapshot이 호출될 때마다 UI를 업데이트합니다.
                updateUI(answers, revealed);
            });
        };

        const updateUI = (answers, revealed) => {
            if (revealed) {
                resultsContainer.classList.remove('hidden');
                participantView.classList.add('hidden');
                adminView.classList.add('hidden');
                adminLoginView.classList.add('hidden');
                passwordModal.classList.add('hidden');
                
                resultsListFinal.innerHTML = '';
                answers.forEach(answer => {
                    const li = document.createElement('li');
                    li.classList.add('p-3', 'bg-white', 'rounded-xl', 'shadow-md', 'mb-2', 'border', 'border-gray-200');
                    li.innerHTML = `<strong class="text-orange-700 font-semibold">${answer.name}</strong>: <span class="text-gray-700">${answer.answer}</span>`;
                    resultsListFinal.appendChild(li);
                });
            } else {
                resultsContainer.classList.add('hidden');
                
                if (isAdmin) {
                    participantView.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    adminLoginView.classList.add('hidden');
                    const submittedAnswersCount = answers.length;
                    statusMessage.textContent = `현재 ${submittedAnswersCount}개의 답이 제출되었습니다.`;
                    resultsListAdmin.innerHTML = '';
                    if (submittedAnswersCount > 0) {
                        answers.forEach(answer => {
                            const li = document.createElement('li');
                            li.classList.add('p-3', 'bg-gray-100', 'rounded-xl', 'shadow-sm', 'mb-2');
                            li.innerHTML = `<span class="text-gray-600 font-medium">${answer.name}</span>님이 답을 제출했습니다.`;
                            resultsListAdmin.appendChild(li);
                        });
                    }
                } else {
                    participantView.classList.remove('hidden');
                    adminView.classList.add('hidden');
                    adminLoginView.classList.add('hidden');
                    passwordModal.classList.add('hidden');
                }
            }
        };

        quizForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showTemporaryMessage("인증 준비 중입니다. 잠시 후 다시 시도해주세요.", 'bg-yellow-500');
                return;
            }

            const name = document.getElementById('participant-name').value;
            const answer = document.getElementById('quiz-answer').value;

            if (name.trim() === '' || answer.trim() === '') {
                showTemporaryMessage("이름과 답을 모두 입력해주세요.", 'bg-red-500');
                return;
            }

            try {
                await addDoc(collection(db, QUIZ_COLLECTION_PATH), {
                    name,
                    answer,
                    revealed: false,
                    createdAt: new Date()
                });

                quizForm.reset();
                showTemporaryMessage("답변이 성공적으로 제출되었습니다!", 'bg-green-500');
            } catch (e) {
                console.error("Error submitting answer: ", e);
                showTemporaryMessage("답변 제출 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        revealButton.addEventListener('click', async () => {
            if (!isAuthReady) return;
            try {
                const q = query(collection(db, QUIZ_COLLECTION_PATH));
                const snapshot = await getDocs(q);
                
                const updates = snapshot.docs.map(d => {
                    return updateDoc(d.ref, { revealed: true });
                });
                await Promise.all(updates);
                showTemporaryMessage("정답이 공개되었습니다!", 'bg-green-500');
            } catch (e) {
                console.error("Error revealing answers: ", e);
                showTemporaryMessage("정답 공개 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        resetButton.addEventListener('click', async () => {
            if (!isAuthReady) return;
            try {
                const q = query(collection(db, QUIZ_COLLECTION_PATH));
                const snapshot = await getDocs(q);
                
                const deletions = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletions);
                showTemporaryMessage("퀴즈가 초기화되었습니다!", 'bg-red-500');
            } catch (e) {
                console.error("Error resetting quiz: ", e);
                showTemporaryMessage("퀴즈 초기화 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        adminButton.addEventListener('click', () => {
            participantView.classList.add('hidden');
            adminView.classList.add('hidden');
            adminLoginView.classList.remove('hidden');
        });

        adminLoginButton.addEventListener('click', () => {
            const password = adminLoginPass.value;
            if (password === adminPassword) {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                showTemporaryMessage("관리자 로그인 성공!", 'bg-green-500');
                setupRealtimeListener();
            } else {
                showTemporaryMessage("비밀번호가 올바르지 않습니다.", 'bg-red-500');
            }
        });

        backToParticipantButton.addEventListener('click', () => {
            isAdmin = false;
            localStorage.removeItem('isAdmin');
            setupRealtimeListener();
        });

        backToAdminButton.addEventListener('click', () => {
            participantView.classList.add('hidden');
            adminView.classList.add('hidden');
            adminLoginView.classList.remove('hidden');
            adminLoginPass.value = '';
        });

        // 비밀번호 변경 버튼 클릭 시 모달 표시
        changePasswordButton.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });
        
        // 비밀번호 변경 모달 취소 버튼
        cancelChangePassButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            changePassForm.reset();
        });

        // 비밀번호 변경 폼 제출 처리
        changePassForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const current = currentPassInput.value;
            const newPass = newPassInput.value;
            const confirmNewPass = confirmNewPassInput.value;

            if (current !== adminPassword) {
                showTemporaryMessage("현재 비밀번호가 일치하지 않습니다.", 'bg-red-500');
                return;
            }

            if (newPass !== confirmNewPass) {
                showTemporaryMessage("새 비밀번호가 일치하지 않습니다.", 'bg-red-500');
                return;
            }

            // 비밀번호 변경
            adminPassword = newPass;
            showTemporaryMessage("비밀번호가 성공적으로 변경되었습니다!", 'bg-green-500');
            passwordModal.classList.add('hidden');
            changePassForm.reset();
            // 경고: 실제 애플리케이션에서는 서버에 변경 요청을 보내고,
            // 하드코딩된 변수 대신 안전한 방법으로 비밀번호를 업데이트해야 합니다.
        });

        const showTemporaryMessage = (message, colorClass) => {
            const tempDiv = document.createElement('div');
            tempDiv.textContent = message;
            tempDiv.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-semibold transition-all duration-300 ease-in-out z-50 ${colorClass}`;
            document.body.appendChild(tempDiv);
            setTimeout(() => {
                tempDiv.classList.add('opacity-0');
                setTimeout(() => tempDiv.remove(), 500);
            }, 3000);
        };
        
        window.onload = initFirebase;
    </script>

    <!-- UI -->
    <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-orange-100 to-yellow-100">
        <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 md:p-12 max-w-lg w-full">
            <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-900 mb-2">퀴즈감귤</h1>
            <p class="text-center text-gray-600 mb-8">퀴즈의 답을 제출하고, 정답이 공개될 때까지 기다려 주세요!</p>
            
            <!-- 참가자 화면 -->
            <div id="participant-view">
                <form id="quiz-form" class="space-y-4">
                    <input type="text" id="participant-name" placeholder="이름을 입력하세요" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                    <textarea id="quiz-answer" placeholder="여기에 답을 적어주세요" required class="w-full p-4 h-32 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800"></textarea>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl">답 제출하기</button>
                </form>
                <div class="mt-4 text-center">
                    <button id="admin-button" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">관리자</button>
                </div>
            </div>

            <!-- 관리자 로그인 화면 -->
            <div id="admin-login-view" class="mt-8 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">관리자 로그인</h2>
                <div class="space-y-4">
                    <input type="password" id="admin-login-password" placeholder="비밀번호를 입력하세요" class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                    <button id="admin-login-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl">로그인</button>
                    <button id="back-to-participant" class="w-full text-gray-500 hover:text-gray-700 font-semibold py-2 px-6 rounded-xl transition-all duration-300 ease-in-out">돌아가기</button>
                </div>
            </div>

            <!-- 관리자 화면 -->
            <div id="admin-view" class="mt-8 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">현재 제출된 답변</h2>
                <p id="status-message" class="text-center text-gray-600 font-medium mb-4">현재 0개의 답이 제출되었습니다.</p>
                <div class="rounded-xl p-4 border border-gray-200 bg-gray-50 shadow-inner max-h-64 overflow-y-auto">
                    <ul id="quiz-results-list-admin" class="space-y-3">
                        <!-- 답변이 여기에 표시됩니다 -->
                    </ul>
                </div>
                <div class="mt-6 flex flex-col md:flex-row justify-center gap-4">
                    <button id="reveal-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl w-full md:w-auto">정답 공개하기</button>
                    <button id="reset-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl w-full md:w-auto">새 퀴즈 시작하기</button>
                </div>
                <div class="mt-4 text-center">
                    <button id="change-password-button" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">비밀번호 변경</button>
                </div>
            </div>

            <!-- 결과 화면 (정답 공개 후) -->
            <div id="results-container" class="mt-8 hidden">
                <h2 class="text-3xl font-bold text-center text-orange-700 mb-4">정답 공개!</h2>
                <div class="rounded-xl p-4 border border-gray-200 bg-white shadow-lg max-h-80 overflow-y-auto">
                    <ul id="quiz-results-list-final" class="space-y-3">
                        <!-- 최종 답변 목록이 여기에 표시됩니다 -->
                    </ul>
                </div>
                <div class="mt-4 text-center">
                    <button id="back-to-admin" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">관리자 화면으로 돌아가기</button>
                </div>
            </div>

            <!-- 비밀번호 변경 모달 -->
            <div id="password-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">비밀번호 변경</h2>
                    <form id="change-password-form" class="space-y-4">
                        <input type="password" id="current-password" placeholder="현재 비밀번호" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <input type="password" id="new-password" placeholder="새 비밀번호" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <input type="password" id="confirm-new-password" placeholder="새 비밀번호 확인" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <div class="flex justify-between gap-4">
                            <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-xl transition-all duration-300 ease-in-out shadow-lg">변경</button>
                            <button type="button" id="cancel-change-password" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-xl transition-all duration-300 ease-in-out shadow-lg">취소</button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>
</body>
</html>
