<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 Firebase 연동 퀴즈 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
    
    <!-- Firebase SDK (사용자 정의 설정용) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 (여기에 사용자님의 Firebase config를 붙여넣으세요)
        // 예시: const firebaseConfig = { apiKey: "...", authDomain: "...", ... };
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCKUUty_87HsQIlpsSNZunnHpULAlM32Pc",
  authDomain: "quiz-gamgule.firebaseapp.com",
  projectId: "quiz-gamgule",
  storageBucket: "quiz-gamgule.firebasestorage.app",
  messagingSenderId: "338874271866",
  appId: "1:338874271866:web:ea13115a67b9c182fcd3c3",
  measurementId: "G-S7ML16E2CY"
};

        let app, db, auth;
        let userId = null;
        let isAdmin = false;
        let adminPassword = 'gamgyul';

        const quizForm = document.getElementById('quiz-form');
        const resultsContainer = document.getElementById('results-container');
        const participantView = document.getElementById('participant-view');
        const adminView = document.getElementById('admin-view');
        const adminLoginView = document.getElementById('admin-login-view');
        const revealButton = document.getElementById('reveal-button');
        const resetButton = document.getElementById('reset-button');
        const statusMessage = document.getElementById('status-message');
        const resultsListAdmin = document.getElementById('quiz-results-list-admin');
        const resultsListFinal = document.getElementById('quiz-results-list-final');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLoginPass = document.getElementById('admin-login-password');
        const backToParticipantButton = document.getElementById('back-to-participant');
        const backToAdminButton = document.getElementById('back-to-admin');
        const adminButton = document.getElementById('admin-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const changePasswordButton = document.getElementById('change-password-button');
        const passwordModal = document.getElementById('password-modal');
        const changePassForm = document.getElementById('change-password-form');
        const cancelChangePassButton = document.getElementById('cancel-change-password');
        const currentPassInput = document.getElementById('current-password');
        const newPassInput = document.getElementById('new-password');
        const confirmNewPassInput = document.getElementById('confirm-new-password');

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    showTemporaryMessage("Firebase 설정이 누락되었습니다. 'firebaseConfig'를 채워주세요.", 'bg-red-500');
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 익명 로그인
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `내 ID: ${userId}`;
                        setupRealtimeListeners();
                        updateUI();
                    } else {
                        console.log("No user is signed in.");
                        userId = null;
                        userIdDisplay.textContent = "로그인되지 않음";
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showTemporaryMessage("Firebase 연결 오류가 발생했습니다. 설정을 확인해주세요.", 'bg-red-500');
            }
        };

        const getAnswersCollection = () => {
            return collection(db, `quiz_answers`);
        };

        const getStatusDoc = () => {
            return doc(db, `quiz_status/status`);
        };

        const setupRealtimeListeners = () => {
            if (!db) return;
            
            onSnapshot(getAnswersCollection(), (snapshot) => {
                const answers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAdminList(answers);
                updateResultsList(answers);
                console.log("Answers updated in real-time.");
            });

            onSnapshot(getStatusDoc(), (doc) => {
                const data = doc.data();
                if (data && data.revealed) {
                    showResultsView();
                } else {
                    if (isAdmin) {
                        showAdminView();
                    } else {
                        showParticipantView();
                    }
                }
            });
        };

        const showParticipantView = () => {
            participantView.classList.remove('hidden');
            adminView.classList.add('hidden');
            adminLoginView.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            passwordModal.classList.add('hidden');
        };

        const showAdminView = () => {
            participantView.classList.add('hidden');
            adminView.classList.remove('hidden');
            adminLoginView.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            passwordModal.classList.add('hidden');
        };

        const showResultsView = () => {
            participantView.classList.add('hidden');
            adminView.classList.add('hidden');
            adminLoginView.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            passwordModal.classList.add('hidden');
        };

        const updateUI = () => {
            // Firestore 리스너가 UI를 업데이트하므로 별도로 호출할 필요 없음
        };
        
        const updateAdminList = (answers) => {
            resultsListAdmin.innerHTML = '';
            answers.forEach(answer => {
                const li = document.createElement('li');
                li.classList.add('p-3', 'bg-gray-100', 'rounded-xl', 'shadow-sm', 'mb-2');
                li.innerHTML = `<span class="text-gray-600 font-medium">${answer.name}</span>님이 답을 제출했습니다.`;
                resultsListAdmin.appendChild(li);
            });
            statusMessage.textContent = `현재 ${answers.length}개의 답이 제출되었습니다.`;
        };

        const updateResultsList = (answers) => {
            resultsListFinal.innerHTML = '';
            answers.forEach(answer => {
                const li = document.createElement('li');
                li.classList.add('p-3', 'bg-white', 'rounded-xl', 'shadow-md', 'mb-2', 'border', 'border-gray-200');
                li.innerHTML = `<strong class="text-orange-700 font-semibold">${answer.name}</strong>: <span class="text-gray-700">${answer.answer}</span>`;
                resultsListFinal.appendChild(li);
            });
        };

        quizForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('participant-name').value;
            const answer = document.getElementById('quiz-answer').value;

            if (name.trim() === '' || answer.trim() === '') {
                showTemporaryMessage("이름과 답을 모두 입력해주세요.", 'bg-red-500');
                return;
            }

            try {
                await addDoc(getAnswersCollection(), {
                    name,
                    answer,
                    timestamp: new Date().toISOString()
                });
                quizForm.reset();
                showTemporaryMessage("답변이 성공적으로 제출되었습니다!", 'bg-green-500');
            } catch (error) {
                console.error("Error submitting answer:", error);
                showTemporaryMessage("답변 제출 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        revealButton.addEventListener('click', async () => {
            try {
                await setDoc(getStatusDoc(), { revealed: true }, { merge: true });
                showTemporaryMessage("정답이 공개되었습니다!", 'bg-green-500');
            } catch (error) {
                console.error("Error revealing answers:", error);
                showTemporaryMessage("정답 공개 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        resetButton.addEventListener('click', async () => {
            try {
                const querySnapshot = await getDocs(getAnswersCollection());
                querySnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });

                await setDoc(getStatusDoc(), { revealed: false }, { merge: true });

                showTemporaryMessage("퀴즈가 초기화되었습니다!", 'bg-red-500');
            } catch (error) {
                console.error("Error resetting quiz:", error);
                showTemporaryMessage("퀴즈 초기화 중 오류가 발생했습니다.", 'bg-red-500');
            }
        });

        adminButton.addEventListener('click', () => {
            participantView.classList.add('hidden');
            adminView.classList.add('hidden');
            adminLoginView.classList.remove('hidden');
        });

        adminLoginButton.addEventListener('click', () => {
            const password = adminLoginPass.value;
            if (password === adminPassword) {
                isAdmin = true;
                showTemporaryMessage("관리자 로그인 성공!", 'bg-green-500');
                showAdminView();
            } else {
                showTemporaryMessage("비밀번호가 올바르지 않습니다.", 'bg-red-500');
            }
        });

        backToParticipantButton.addEventListener('click', () => {
            isAdmin = false;
            showParticipantView();
        });

        backToAdminButton.addEventListener('click', () => {
            setDoc(getStatusDoc(), { revealed: false }, { merge: true })
                .then(() => {
                    showTemporaryMessage("관리자 화면으로 돌아갑니다.", 'bg-blue-500');
                })
                .catch(error => {
                    console.error("Error returning to admin view:", error);
                    showTemporaryMessage("전환 중 오류가 발생했습니다.", 'bg-red-500');
                });
        });
        
        changePasswordButton.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });
        
        cancelChangePassButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            changePassForm.reset();
        });

        changePassForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const current = currentPassInput.value;
            const newPass = newPassInput.value;
            const confirmNewPass = confirmNewPassInput.value;

            if (current !== adminPassword) {
                showTemporaryMessage("현재 비밀번호가 일치하지 않습니다.", 'bg-red-500');
                return;
            }

            if (newPass !== confirmNewPass) {
                showTemporaryMessage("새 비밀번호가 일치하지 않습니다.", 'bg-red-500');
                return;
            }

            adminPassword = newPass;
            showTemporaryMessage("비밀번호가 성공적으로 변경되었습니다!", 'bg-green-500');
            passwordModal.classList.add('hidden');
            changePassForm.reset();
        });

        const showTemporaryMessage = (message, colorClass) => {
            const tempDiv = document.createElement('div');
            tempDiv.textContent = message;
            tempDiv.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-semibold transition-all duration-300 ease-in-out z-50 ${colorClass}`;
            document.body.appendChild(tempDiv);
            setTimeout(() => {
                tempDiv.classList.add('opacity-0');
                setTimeout(() => tempDiv.remove(), 500);
            }, 3000);
        };
        
        window.onload = initFirebase;
    </script>

    <!-- UI -->
    <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-orange-100 to-yellow-100">
        <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 md:p-12 max-w-lg w-full">
            <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-900 mb-2">퀴즈감귤</h1>
            <p class="text-center text-gray-600 mb-8">퀴즈의 답을 제출하고, 정답이 공개될 때까지 기다려 주세요!</p>
            
            <!-- 참가자 화면 -->
            <div id="participant-view" class="hidden">
                <form id="quiz-form" class="space-y-4">
                    <input type="text" id="participant-name" placeholder="이름을 입력하세요" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                    <textarea id="quiz-answer" placeholder="여기에 답을 적어주세요" required class="w-full p-4 h-32 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800"></textarea>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl">답 제출하기</button>
                </form>
                <div class="mt-4 text-center">
                    <button id="admin-button" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">관리자</button>
                </div>
            </div>

            <!-- 관리자 로그인 화면 -->
            <div id="admin-login-view" class="mt-8 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">관리자 로그인</h2>
                <div class="space-y-4">
                    <input type="password" id="admin-login-password" placeholder="비밀번호를 입력하세요" class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                    <button id="admin-login-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl">로그인</button>
                    <button id="back-to-participant" class="w-full text-gray-500 hover:text-gray-700 font-semibold py-2 px-6 rounded-xl transition-all duration-300 ease-in-out">돌아가기</button>
                </div>
            </div>

            <!-- 관리자 화면 -->
            <div id="admin-view" class="mt-8 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">현재 제출된 답변</h2>
                <p id="status-message" class="text-center text-gray-600 font-medium mb-4">현재 0개의 답이 제출되었습니다.</p>
                <div class="rounded-xl p-4 border border-gray-200 bg-gray-50 shadow-inner max-h-64 overflow-y-auto">
                    <ul id="quiz-results-list-admin" class="space-y-3">
                        <!-- 답변이 여기에 표시됩니다 -->
                    </ul>
                </div>
                <div class="mt-6 flex flex-col md:flex-row justify-center gap-4">
                    <button id="reveal-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl w-full md:w-auto">정답 공개하기</button>
                    <button id="reset-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl w-full md:w-auto">새 퀴즈 시작하기</button>
                </div>
                <div class="mt-4 text-center">
                    <button id="change-password-button" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">비밀번호 변경</button>
                </div>
            </div>

            <!-- 결과 화면 (정답 공개 후) -->
            <div id="results-container" class="mt-8 hidden">
                <h2 class="text-3xl font-bold text-center text-orange-700 mb-4">정답 공개!</h2>
                <div class="rounded-xl p-4 border border-gray-200 bg-white shadow-lg max-h-80 overflow-y-auto">
                    <ul id="quiz-results-list-final" class="space-y-3">
                        <!-- 최종 답변 목록이 여기에 표시됩니다 -->
                    </ul>
                </div>
                <div class="mt-4 text-center">
                    <button id="back-to-admin" class="text-sm text-gray-400 hover:text-orange-500 transition-colors duration-200">관리자 화면으로 돌아가기</button>
                </div>
            </div>

            <!-- 비밀번호 변경 모달 -->
            <div id="password-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">비밀번호 변경</h2>
                    <form id="change-password-form" class="space-y-4">
                        <input type="password" id="current-password" placeholder="현재 비밀번호" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <input type="password" id="new-password" placeholder="새 비밀번호" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <input type="password" id="confirm-new-password" placeholder="새 비밀번호 확인" required class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-orange-500 transition-all duration-200 text-gray-800">
                        <div class="flex justify-between gap-4">
                            <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-xl transition-all duration-300 ease-in-out shadow-lg">변경</button>
                            <button type="button" id="cancel-change-password" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-xl transition-all duration-300 ease-in-out shadow-lg">취소</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="user-id-display" class="mt-8 text-center text-sm text-gray-500"></div>
            
        </div>
    </div>
</body>
</html>
